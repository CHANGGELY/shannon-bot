"""
Quant Unified é‡åŒ–äº¤æ˜“ç³»ç»Ÿ
startup.py
"""
import gc
import os.path
import shutil
import sys
import time
import traceback
import warnings
from datetime import datetime, timedelta

import pandas as pd

from config import is_debug, error_webhook_url, utc_offset, runtime_folder
from core.model.account_config import AccountConfig, load_config
from core.real_trading import save_and_merge_select
from core.utils.commons import sleep_until_run_time, next_run_time
from core.utils.datatools import check_data_update_flag
from core.utils.dingding import send_wechat_work_msg
from core.utils.functions import save_select_coin, save_symbol_order, refresh_diff_time
from core.utils.path_kit import get_file_path
from program.step1_prepare_data import prepare_data
from program.step2_calculate_factors import calc_factors
from program.step3_select_coins import select_coins, aggregate_select_results

# ====================================================================================================
# ** è„šæœ¬è¿è¡Œå‰é…ç½® **
# ä¸»è¦æ˜¯è§£å†³å„ç§å„æ ·å¥‡æ€ªçš„é—®é¢˜ä»¬
# ====================================================================================================
warnings.filterwarnings('ignore')  # è¿‡æ»¤ä¸€ä¸‹warningsï¼Œä¸è¦å“åˆ°è€å®äºº

# pandasç›¸å…³çš„æ˜¾ç¤ºè®¾ç½®ï¼ŒåŸºç¡€è¯¾ç¨‹éƒ½æœ‰ä»‹ç»
pd.set_option('display.max_rows', 1000)
pd.set_option('expand_frame_repr', False)  # å½“åˆ—å¤ªå¤šæ—¶ä¸æ¢è¡Œ
pd.set_option('display.unicode.ambiguous_as_wide', True)  # è®¾ç½®å‘½ä»¤è¡Œè¾“å‡ºæ—¶çš„åˆ—å¯¹é½åŠŸèƒ½
pd.set_option('display.unicode.east_asian_width', True)


# ====================================================================================================
# ** æµç¨‹å‡½æ•° **
# ä¸»è¿›ç¨‹ -> run_loop -> run_by_account
# è°ƒåº¦é€»è¾‘åœ¨ run_loop å‡½æ•°ä¸­
# æ ¸å¿ƒé€»è¾‘åœ¨ run_by_account å‡½æ•°ä¸­
# ç¨‹åºçš„ä¸»è¦é€»è¾‘ä¼šåœ¨è¿™è¾¹å†™ä¸€ä¸‹ï¼Œå¯ä»¥è¯•ç”¨å¼‚æ­¥çš„æ–¹æ¡ˆè°ƒç”¨ï¼Œå……åˆ†é‡Šæ”¾æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å†…å­˜
# ====================================================================================================
def run_by_account(account: AccountConfig, run_time: datetime):
    """
    é’ˆå¯¹å½“å‰è´¦æˆ·ï¼Œè¿›è¡Œé€‰å¸ã€ä¸‹å•æ“ä½œ
    :param account: configä¸­è´¦æˆ·é…ç½®çš„ä¿¡æ¯
    :param run_time:  è¿è¡Œæ—¶é—´
    :return:
    """
    # è®°å½•ä¸€ä¸‹æ—¶é—´æˆ³
    r_time = time.time()

    # ====================================================================================================
    # 1. å‡†å¤‡å·¥ä½œ
    # ====================================================================================================
    # å’Œäº¤æ˜“æ‰€å¯¹ä¸€ä¸‹è¡¨
    print('-' * 36, 'è´¦æˆ·å‡†å¤‡', '-' * 36)
    print(f'â³è¿è¡Œæ—¶é—´ï¼š{run_time}ï¼Œå½“å‰æ—¶é—´ï¼š{datetime.now()}')
    refresh_diff_time()

    # æ¸…ç†ä¸€ä¸‹è¿è¡Œè¿‡ç¨‹ä¸­çš„ç¼“å­˜æ•°æ®
    if os.path.exists(runtime_folder):
        shutil.rmtree(runtime_folder)
    runtime_folder.mkdir(parents=True, exist_ok=True)

    # åˆ¤æ–­å½“å‰ç­–ç•¥æŒä»“æ˜¯å¦æ˜¯æ—¥çº¿
    # å¦‚æœæ˜¯æ—¥çº¿æŒä»“åˆ™éœ€è¦åˆ¤æ–­ä¸‹å•æ—¶é—´ï¼Œå°æ—¶çº§åˆ«æŒä»“ä¸éœ€è¦åˆ¤æ–­ä¸‹å•æ—¶é—´
    if account.is_day_period and run_time.hour != utc_offset % 24:  # åªæœ‰å½“å‰å°æ—¶æ˜¯utc0ç‚¹çš„æ—¶å€™ï¼Œæ‰ä¼šä¸‹å•
        print(f'âš ï¸è´¦å·ï¼š{account.name}ï¼Œå½“å‰ä¸æ˜¯éœ€è¦ä¸‹å•çš„æ—¶é—´ï¼Œè·³è¿‡Â·Â·Â·')
        return

    # æ›´æ–°ä¸€ä¸‹äº¤æ˜“æ‰€çš„è¡Œæƒ…æ•°æ®ï¼Œè·å–æœ€æ–°å¸ç§ä¿¡æ¯ï¼Œæ”¾ç½®åœ¨ç¼“å­˜ä¸­
    account.bn.fetch_market_info('swap')
    if account.use_spot:
        account.bn.fetch_market_info('spot')

    # æ’¤é”€æ‰€æœ‰å¸ç§æŒ‚å•
    if is_debug:
        print(f'ğŸ[DEBUG] - è·³è¿‡æ’¤å•\n')
    elif not account.is_api_ok():
        print(f'ğŸš¨APIæœªé…ç½® - è·³è¿‡æ’¤å•\n')
    else:
        account.bn.cancel_all_swap_orders()  # åˆçº¦æ’¤å•
        account.bn.cancel_all_spot_orders()  # ç°è´§æ’¤å•

    # ====================================================================================================
    # 2. è¯»å–å®ç›˜æ‰€éœ€æ•°æ®ï¼Œå¹¶åšç®€å•çš„é¢„å¤„ç†
    # ====================================================================================================
    print('-' * 36, 'å‡†å¤‡æ•°æ®', '-' * 36)
    prepare_data(account, run_time)

    # ====================================================================================================
    # 3. è®¡ç®—å› å­
    # ====================================================================================================
    print('-' * 36, 'å› å­è®¡ç®—', '-' * 36)
    calc_factors(account, run_time)

    # ====================================================================================================
    # 4. é€‰å¸
    # - æ³¨æ„ï¼šé€‰å®Œä¹‹åï¼Œæ¯ä¸€ä¸ªç­–ç•¥çš„é€‰å¸ç»“æœä¼šè¢«ä¿å­˜åˆ°ç¡¬ç›˜
    # ====================================================================================================
    print('-' * 36, 'æ¡ä»¶é€‰å¸', '-' * 36)
    select_coins(account)
    if account.strategy_short is not None:
        select_coins(account, is_short=True)  # é€‰å¸

    # ====================================================================================================
    # 5. æ•´ç†é€‰å¸ç»“æœ
    # - æŠŠæ¯ä¸€ä¸ªç­–ç•¥çš„é€‰å¸ç»“æœèšåˆæˆä¸€ä¸ªdf
    # ====================================================================================================
    # ä¸ºäº†å……åˆ†é‡Šæ”¾å¾ªç¯ä¸­çš„å†…å­˜ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å¤šè¿›ç¨‹æ¥æ‰§è¡Œå‡½æ•°
    select_results = aggregate_select_results(account)

    # ====================================================================================================
    # 6. ä¿å­˜å¹¶åˆå¹¶æœ¬åœ°é€‰å¸æ–‡ä»¶
    # ====================================================================================================
    # å¦‚æœé€‰å¸æ•°æ®ä¸ºç©ºï¼Œå¹¶ä¸”å½“å‰è´¦å·æ²¡æœ‰ä»»ä½•æŒä»“ï¼Œç›´æ¥è·³è¿‡åç»­æ“ä½œ
    print('-' * 36, 'ä¿å­˜é€‰å¸', '-' * 36)
    spot_position = account.spot_position
    swap_position = account.swap_position

    if select_results.empty and spot_position.empty and swap_position.empty:
        return
    select_results = save_and_merge_select(account, select_results)
    print(f'é€‰å¸åŠèµ„é‡‘åˆ†é…ï¼š{select_results}\n'
          f'âœ…{account.name}ç­–ç•¥è®¡ç®—æ€»æ¶ˆè€—æ—¶é—´ï¼š{time.time() - r_time:.2f}sï¼Œ\n')

    # ====================================================================================================
    # 7. è®¡ç®—ä¸‹å•ä¿¡æ¯
    # ====================================================================================================
    print('-' * 36, 'è®¡ç®—ä¸‹å•', '-' * 36)
    if not account.is_api_ok():
        print('âš ï¸äº¤æ˜“æ‰€APIä¸å¯ç”¨ï¼Œè·³è¿‡ä¸‹å•')
        return

    symbol_order = account.calc_order_amount(select_results)
    print(f'â„¹ï¸ä¸‹å•ä¿¡æ¯ï¼š{symbol_order}\n')

    print(f'âœ…{account.name}ç­–ç•¥è®¡ç®—æ€»æ¶ˆè€—æ—¶é—´ï¼š{time.time() - r_time:.2f}sï¼Œå‡†å¤‡ä¸‹å•...\n')

    if is_debug:
        print(f'ğŸ[DEBUG] - è·³è¿‡ä¸‹å•\n')
        return

    if symbol_order.empty:
        print(f'âš ï¸ä¸‹å•ä¿¡æ¯ä¸ºç©ºï¼Œè·³è¿‡ä¸‹å•\n')
        return

    # ====================================================================================================
    # 8. ä¸‹å•
    # ====================================================================================================
    print('-' * 36, 'å¼€å§‹ä¸‹å•', '-' * 36)
    account.proceed_spot_order(symbol_order, is_only_sell=True)
    account.proceed_swap_order(symbol_order)
    account.proceed_spot_order(symbol_order, is_only_sell=False)

    # ====================================================================================================
    # 9. è®°å½•ä¸‹å•æ•°æ®
    # ====================================================================================================
    # ä¿å­˜é€‰å¸æ•°æ®
    save_select_coin(select_results, run_time, account.name)

    # ä¿å­˜ä¸‹å•æ•°æ®
    save_symbol_order(symbol_order, run_time, account.name)


def run_statistics(run_time):
    print('-' * 36, 'å¼€å§‹ç»Ÿè®¡', '-' * 36)
    python_exec = sys.executable  # è·å–å½“å‰ç¯å¢ƒä¸‹çš„pythonè§£é‡Šå™¨ï¼Œä¹Ÿæ˜¯ç»™ç»Ÿè®¡è„šæœ¬ç”¨çš„
    os.system(f'{python_exec} {get_file_path("core", "utils", "statistics.py")} {int(run_time.timestamp())}')
    print('âœ…ç»Ÿè®¡è¿è¡Œç»“æŸ\n')


def main() -> datetime | None:
    """
    æ— é™å¾ªç¯è¿™ä¸ªå‡½æ•°â™¾ï¸
    :return: æˆåŠŸæ‰§è¡Œçš„è¯ï¼Œè¿”å›æœ¬æ¬¡è¿è¡Œçš„æ—¶é—´ï¼Œå¦åˆ™æ˜¯None
    """
    print('=' * 36, 'ğŸš€å¾ªç¯å¼€å§‹', '=' * 36)

    # ====================================================================================================
    # 0. è°ƒè¯•ç›¸å…³é…ç½®åŒºåŸŸ
    # ====================================================================================================
    if is_debug:  # è°ƒè¯•æ¨¡å¼ï¼Œä¸è¿›è¡Œsleepï¼Œç›´æ¥ç»§ç»­å¾€åè¿è¡Œ
        run_time = next_run_time('1h', 0) - timedelta(hours=1)
        if run_time > datetime.now():
            run_time -= timedelta(hours=1)
    else:
        run_time = sleep_until_run_time('1h', if_sleep=True)

    # ====================================================================================================
    # 1. æ›´æ–°ã€æ£€æŸ¥è´¦æˆ·ä¿¡æ¯
    # ====================================================================================================
    account = load_config()
    account.update_account_info()

    # ====================================================================================================
    # 2. ç­‰å¾…æ•°æ®ä¸­å¿ƒå®Œæˆæ•°æ®æ›´æ–°
    # ====================================================================================================
    print(f'â„¹ï¸æ£€æŸ¥æ•°æ®ä¸­å¿ƒï¼Œç›®æ ‡è¿è¡Œæ—¶é—´ï¼š{run_time}')
    # æ£€æŸ¥æ•°æ®ä¸­å¿ƒæ•°æ®æ˜¯å¦æ›´æ–°
    is_data_ready = check_data_update_flag(run_time)

    # åˆ¤æ–­æ•°æ®æ˜¯å¦æ›´æ–°å¥½äº†
    if not is_data_ready:  # æ²¡æœ‰æ›´æ–°å¥½ï¼Œè·³è¿‡å½“å‰ä¸‹å•
        print(f'âš ï¸æ•°æ®ä¸­å¿ƒæ•°æ®æœªæ›´æ–°ï¼Œè·³è¿‡å½“å‰ï¼Œ{run_time}')
        return
    print('âœ…æ•°æ®ä¸­å¿ƒæ•°æ®æ›´æ–°å®Œæˆï¼Œå‡†å¤‡é€‰å¸ä¸‹å•\n')

    # ====================================================================================================
    # 3. é’ˆå¯¹è´¦æˆ·é…ç½®ï¼Œè¿›è¡Œå› å­è®¡ç®—ã€é€‰å¸ã€ä¸‹å•
    # ====================================================================================================
    run_by_account(account, run_time)
    gc.collect()  # å¼ºåˆ¶åƒåœ¾å›æ”¶

    # å¼€å§‹è¿›è¡Œè´¦æˆ·ç»Ÿè®¡
    # ====================================================================================================
    # 4. é’ˆå¯¹è´¦æˆ·é…ç½®ï¼Œç»Ÿè®¡ä¸‹å•ä¿¡æ¯ï¼Œè´¦æˆ·èµ„é‡‘ï¼Œç­–ç•¥è¡¨ç°ï¼Œå¹¶å‘é€èµ„é‡‘æ›²çº¿
    # ====================================================================================================
    if is_debug:
        print(f'ğŸ[DEBUG] - è·³è¿‡ç»Ÿè®¡\n')
    else:
        run_statistics(run_time)

    # æœ¬æ¬¡å¾ªç¯ç»“æŸ
    print('=' * 36, 'ğŸå¾ªç¯ç»“æŸ', '=' * 36)
    print('â³23ç§’åè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯')
    time.sleep(23)

    return run_time


if __name__ == '__main__':
    if is_debug:
        print('ğŸŸ ' * 17, f'è°ƒè¯•æ¨¡å¼', 'ğŸŸ ' * 17)
    else:
        print('ğŸŸ¢' * 17, f'æ­£å¼æ¨¡å¼', 'ğŸŸ¢' * 17)
    print(f'ğŸ“¢ç³»ç»Ÿå¯åŠ¨ä¸­ï¼Œç¨ç­‰...')
    time.sleep(1.5)

    # ====================================================================================================
    # è¿è¡Œå‰è‡ªæ£€å’Œå‡†å¤‡
    # ====================================================================================================
    # åˆå§‹åŒ–è´¦æˆ·
    account_config = load_config()
    print(account_config)

    # è‡ªæ£€
    if is_debug:
        print('ğŸ[DEBUG] - è·³è¿‡è‡ªæ£€')
    elif not account_config.is_api_ok():
        print('ğŸš¨äº¤æ˜“æ‰€APIä¸å¯ç”¨ï¼Œè·³è¿‡è‡ªæ£€')
    else:
        print(f'{account_config.name} æ£€æŸ¥æ æ†ã€æŒä»“æ¨¡å¼ã€ä¿è¯é‡‘æ¨¡å¼...')
        refresh_diff_time()  # åˆ·æ–°ä¸äº¤æ˜“æ‰€çš„æ—¶å·®
        account_config.bn.reset_max_leverage()  # æ£€æŸ¥æ æ†
        account_config.bn.set_single_side_position()  # æ£€æŸ¥å¹¶ä¸”è®¾ç½®æŒä»“æ¨¡å¼ï¼šå•å‘æŒä»“
        account_config.bn.set_multi_assets_margin()  # æ£€æŸ¥è”åˆä¿è¯é‡‘æ¨¡å¼
        time.sleep(2)  # å¤šè´¦æˆ·ä¹‹é—´ï¼Œåœé¡¿ä¸€ä¸‹
        print('âœ…è‡ªæ£€å®Œæˆ')
        time.sleep(2)

    # ====================================================================================================
    # å®ç›˜ä¸»ç¨‹åºï¼Œç”µä¸åœæˆ‘ä¸åœ
    # ====================================================================================================
    while True:
        try:
            main()  # å®ç›˜çš„ä¸»è¿›ç¨‹
        except Exception as err:
            msg = 'âŒç³»ç»Ÿå‡ºé”™ï¼Œ10sä¹‹åé‡æ–°è¿è¡Œï¼Œå‡ºé”™åŸå› : ' + str(err)
            print(msg)
            print(traceback.format_exc())
            send_wechat_work_msg(msg, error_webhook_url)
            time.sleep(11)  # ä¼‘æ¯åä¸€ç§’é’Ÿï¼Œå†å†²
        finally:
            # å¦‚æœæ˜¯è°ƒè¯•æ¨¡å¼ï¼Œå°±ä¸ä¼šè‡ªåŠ¨æ— é™è¿è¡Œ
            if is_debug:
                break
