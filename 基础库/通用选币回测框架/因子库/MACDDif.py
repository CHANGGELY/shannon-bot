"""
邢不行™️选币框架
Python数字货币量化投资课程

版权所有 ©️ 邢不行
微信: xbx8662

未经授权，不得复制、修改、或使用本代码的全部或部分内容。仅限个人学习用途，禁止商业用途。

Author: 邢不行
--------------------------------------------------------------------------------
MACD 因子 (仅输出 DIF 值)
核心逻辑：计算 快线EMA - 慢线EMA
"""
import pandas as pd
import numpy as np


def signal(candle_df, param, *args):
    """
    计算 MACD 的 DIF 值
    :param candle_df: 单个币种的K线数据
    :param param: 快线周期 (Fast EMA)，标准通常为 12
    :param args: args[0] 为因子名称
    :return: 包含因子数据的 K 线数据
    """
    factor_name = args[0]

    # =========================================================================
    # 1. 确定 MACD 的三个参数
    # =========================================================================
    # 标准 MACD 参数是 (12, 26, 9)
    # 为了支持参数遍历，我们将 'param' 视为 快线周期 (12)
    # 慢线周期 (26) 和 信号线周期 (9) 则按照比例自动计算

    n_fast = int(param)

    # 按标准 12:26 的比例计算慢线，并确保至少比快线大 1
    n_slow = int(n_fast * (26 / 12))
    if n_slow <= n_fast:
        n_slow = n_fast + 1

    # 按标准 12:9 的比例计算信号线 (虽然计算 DIF 不需要它，但为了逻辑完整保留)
    n_signal = int(n_fast * (9 / 12))

    # =========================================================================
    # 2. 计算 EMA (指数移动平均)
    # =========================================================================
    # adjust=False 是常用的技术指标计算方式
    ema_fast = candle_df['close'].ewm(span=n_fast, adjust=False).mean()
    ema_slow = candle_df['close'].ewm(span=n_slow, adjust=False).mean()

    # =========================================================================
    # 3. 计算 DIF (Difference)
    # =========================================================================
    # DIF = 快线 - 慢线
    dif = ema_fast - ema_slow

    # 4. 赋值
    candle_df[factor_name] = dif

    return candle_df